# 密码学中的单向函数

在密码学中，我们经常听到各种各样的术语: 加密，解密，承诺，零知识证明。很多技术的背后，在数学上是统一的。比如，签名和零知识证明有时候是同一回事，这篇文章，我们主要讲解一个常见的技术：单向函数。

单向函数简单的说就是： $Y = F(X)$ 这样一个函数，我们通过 X 可以很方便的求出 Y，但是知道Y 我们很难求出 X。

## Hash函数

哈希函数就是一个单项函数， $y = Sha256(x)$ , 知道x，可以非常方便的求Hash，但是知道Hash无法求出x。单向函数可以用来做承诺。承诺的意思就是说，我先公开y，然后在特定的时机公布x。公开y后，我的x值就是不能改变的，因为无法找到 
x1，x2，使得 y = sha256(x1) 且 y = sha256(x2). hash 作为一个单项函数，能做的事情非常少，大部分情况下作为承诺使用。主要的原因就是，sha256(x1 + x2) 和 sha256（x1） sha256(x2) 没有任何关联，这样能做的事情就非常少。

## 椭圆曲线中的单向函数

椭圆曲线中，也有一个单向函数:

$$
P = G^x
$$

x我们叫做私钥，P就是公钥，这个函数有个特点，通过x 可以很方便的求出P，通过P 无法求出 x。这个本质就是单项函数。既然这个是一个单向函数，那么，这个也有承诺的功能，也就是公开了P，那么就确定了x。当然，椭圆曲线的单向函数有非常好的性质：

$$
G^{(x+y)} = G^xG^y
G^{xc} = (G^x)^c
$$

x, y 可以认为是一个私密的数据， c, $G^x$ 和 $G^y$ 是可以公开的数据，这两者有上面的关系，也就是说，我们可以用公开数据，验证私密数据的操作。这个可以认为是零知识证明，也可以认为是签名。

## 签名的本质

我们先看一下 schonrr 签名:

$$
r = G^k
$$
$$
s = xc+y
$$

这里(r,s) 就是一对签名，x 是私钥，c是一个公开的随机数，可以通过某种规则计算出来，y是一个私密的随机数。我们可以很简单的发现，s的结构和上面的 $x+y$ 的结构类似，只是多个一个常数 c, 通过上面的公式我们可以发现，可以把秘密数据的计算隐藏在背后，通过公开数据的计算，去验证秘密数据的计算。s 是一个私钥加上了一个秘密的随机数混合后的数据，这个数据是可以公开的，但是我们需要验证s中包含了私钥x，验证的办法也很简单:

$$
G^s = G^{xc+y} = (G^x)^cG^y
$$

因为 $(G^x，G^y, c)$  都是公开的数据。s是否是按照我们的规则来构成的，很容易验证。验证方法如下:

$$
A=G^s
$$
$$
B=(G^x)^cG^y
$$

判断: A == B, 如果成立，那么必然s中包含了x。当然，这里的c不能是随便给的，c 和 y 不能是互相独立的，否则有两个自由变量，我们很容易伪造出B。

用户要验证：
$$
G^s = (G^x)^cG^y 
$$
直接两边相乘 $(G^x)^{-c}$
$$
G^y=G^s(G^x)^{-c}
$$
这样，我们就算不知道x，也能构造出符合要求的 G^s 和 G^y.

当然，要避免这样的构造，我们需要约束 c。比如设置 $c = sha256(G^y)$, 这种情况下，我们很难同时满足:

$$
G^y = G^s(G^x)^{-c}
$$

$$
c = sha256(G^y)
$$

因为 y 通过这样的方法求出后，基本上不可能同时满足 $c = sha256(G^y)$, 这个概率和直接猜出 x 的值的概率是一样的。这样构造s的唯一办法就是拥有x私钥。

## ecdsa签名

schonrr签名采用的是一个线性的s。这个签名非常的简单，同时巧妙的避免了 $(G^y, s)$ 可以不通过x构造的问题。当然，签名的本质是利用了一个单向函数，让加密空间构造出的签名，可以在非加密空间得到验证，也就说用公开的数据来验证。schonnr 的线性性质，使得聚合签名变的非常的简单，你可以认为schonnr 的签名本质就是一条直线。  $s=cx+y$ , y 可以认为是截距，x可以认为是斜率。接下来的ecdsa的签名要比 schonnr 签名复杂很多，但是本质上来说，还是加密空间的运算可以在非加密空间来验证。加密空间和非加密空间在数学上有某种运算的规律。

签名:

1. $c = H(m)$ m就是要签名的消息，schonnr签名中 $c = H(m|G^y)$ 
2. 随机产生一个随机数y，计算 $r = g^y$
3. 计算 $s = (c+x*r) * y^-1$  r 和 s 就是签名的内容。

验证:

1. $c = H(m)$
2. 计算 u1 = c * s^-1， u2 = r * s^-1
3. 计算 g^u1 * (g^x)^u2 = g^(u1 + au2) = g^(c * s^-1 + x*r*s^-1) = g^((h+ar) * s^-1) = g^((h+ar) * y^-1*y*s^-1) = g^(s * y * s^-1) = g^y

验证 g^k 的x 轴值是否等于r，如果等于 r 那么验证成功。

